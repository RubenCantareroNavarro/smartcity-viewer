<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Survey: case base</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <style>
        .add_marker_class {
            position: relative;
            box-shadow: inset 0px 1px 0px 0px #f7c5c0;
            background-color: #fc8d83;
            border-radius: 6px;
            border: 1px solid #d83526;
            display: inline-block;
            cursor: pointer;
            color: #ffffff;
            font-family: Arial;
            font-size: 20px;
            font-weight: bold;
            padding: 20px 20px;
            text-decoration: none;
            text-shadow: 0px 1px 0px #b23e35;
        }
        
        .add_marker_class:hover {
            background-color: #e4685d;
        }
        
        .add_marker_class:active {
            /* bottom: 1px; */
            background-color: #c75c52;
            color: #ffffff;
        }
    </style>

    <div id="map"></div>
    <a href="#" class="add_marker_class" onclick="sendResult()">Send result</a>
    <a href="#" class="add_marker_class" onclick="addMarker()">Add marker</a>

    <div style="position: absolute; z-index: 1;">
        <p id="container"></p>
    </div>


    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoicnViZW5jbjkwIiwiYSI6ImNrYWdudzluOTA1Zm0zMW1vcGxiZDFpN3gifQ.Gi7bav34XZCKoS9SczeeDg';
        var ciudad_real = [-3.927374, 38.985531];
        var api_base_url = "http://127.0.0.1:5001"
        var pickers = Array();
        var routes_geometry = Array();
        var cases;
        var active_case = {
            case_id: "",
            origin: "",
            destiny: ""
        };

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/rubencn90/ckfwo9gop092p19uektbw5mz3/draft',
            center: ciudad_real,
            zoom: 14
        });

        map.on('load', function() {
            map.addSource('route', {
                'type': 'geojson',
                lineMetrics: true,
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer({
                'id': 'route_layer',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#ff004c',
                    'line-width': 6,
                    'line-gradient': [
                        'interpolate', ['linear'],
                        ['line-progress'],
                        0,
                        '#8800ff',
                        0.125,
                        '#5100ff',
                        0.250,
                        '#000dff',
                        0.375,
                        '#0066ff',
                        0.5,
                        '#00a2ff',
                        0.625,
                        '#00e5ff',
                        0.750,
                        '#00fff7',
                        0.875,
                        '#00ffc3',
                        1,
                        '#05ff93'
                    ]
                }
            });


            map.loadImage(
                'http://0.0.0.0:8000/assets/linea-de-meta.png',
                function(error, image) {
                    if (error) throw error;
                    map.addImage('goal', image);
                    map.addSource('goal_source', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [{
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': []
                                }
                            }]
                        }
                    });
                    map.addLayer({
                        'id': 'goal_layer',
                        'type': 'symbol',
                        'source': 'goal_source',
                        'layout': {
                            'icon-image': 'goal',
                            'icon-size': 0.07
                        }
                    });
                }
            );

            init_radio_buttons();
        });

        function init_radio_buttons() {
            $.ajax({
                type: "GET",
                url: api_base_url + "/covid19-routes/api/v1.0/ciudad-real/survey/get-cases/",

                success: function(response) {
                    cases = response
                    for (var case_id in cases) {
                        createNewCheckboxt(case_id, case_id, cases[case_id].name);
                    }
                }
            });
        }

        function clean_elements() {
            pickers.forEach(element => element.remove());

            map.getSource("route").setData({
                'type': 'FeatureCollection',
                'features': []
            });

            pickers = Array();
            routes_geometry = Array();
        }

        function init_case() {
            clean_elements();
            initial_picker = new mapboxgl.Marker({
                    draggable: false,
                    color: '#0cf700'
                })
                .setLngLat(active_case.origin)
                .addTo(map);

            pickers.push(initial_picker);

            map.getSource("goal_source").setData({
                'type': 'FeatureCollection',
                'features': [{
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Point',
                        'coordinates': active_case.destiny
                    }
                }]
            });
        }

        function createNewCheckboxt(id, value, label_text) {
            var checkbox = document.createElement('input');
            checkbox.type = 'radio';
            checkbox.id = id;
            checkbox.name = "case_checkbox";
            checkbox.value = value;
            checkbox.addEventListener('change', function() {
                active_case.case_id = this.value;
                active_case.origin = cases[this.value].origin;
                active_case.destiny = cases[this.value].destiny;
                init_case();
            });

            var label = document.createElement('label')
            label.htmlFor = id;
            label.appendChild(document.createTextNode(label_text));

            var br = document.createElement('br');

            var container = document.getElementById('container');
            container.appendChild(checkbox);
            container.appendChild(label);
            container.appendChild(br);
        }

        function addMarker() {
            picker = new mapboxgl.Marker({
                    draggable: true,
                    color: '#00f7da'
                })
                .setPopup(new mapboxgl.Popup().setHTML(pickers.length))
                .setLngLat(map.getCenter())
                .addTo(map);

            picker.on('dragend', updateRoute);
            pickers.push(picker);
            updateRoute();
        }

        function updateRoute() {
            for (var i = pickers.length - 1; i > 0; i--) {
                var destination = pickers[i].getLngLat();
                var origin = pickers[i - 1].getLngLat();

                showRoute('route', 'danger', origin.lat, origin.lng, destination.lat, destination.lng, i);
            }
        }

        function showRoute(source, route_type, origin_lat, origin_lon, destination_lat, destination_lon, index) {
            $.ajax({
                type: "GET",
                url: api_base_url + "/covid19-routes/api/v1.0/ciudad-real/route/",
                data: {
                    route_type: route_type,
                    origin_lat: origin_lat,
                    origin_lon: origin_lon,
                    destination_lat: destination_lat,
                    destination_lon: destination_lon
                },
                success: function(response) {
                    data = prepareJSONLine(response.geometry.coordinates, index);
                    map.getSource(source).setData(data);
                }
            });
        }

        function prepareJSONLine(new_coordinates, index) {
            if (routes_geometry.length == index - 1) {
                routes_geometry.push(new_coordinates);
            } else {
                routes_geometry[index - 1] = new_coordinates;
            }

            data = {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': preparePoints()
                }
            };
            return data;
        }

        function preparePoints() {
            coordinates = Array();
            routes_geometry.forEach(element => {
                element.forEach(element2 => {
                    coordinates.push(element2);
                });
            });
            return coordinates;
        }

        function sendResult() {
            if (routes_geometry.length == 0) {
                alert("The route is empty. Please, add markers from origin to destination.");
                return
            }

            if (confirm("Are you sure?")) {
                var data = {
                    "type": "Feature",
                    "geometry": {
                        "type": "LineString",
                        "coordinates": preparePoints()
                    },
                    "properties": {
                        "case_id": active_case.case_id,
                        "origin": active_case.origin,
                        "destiny": active_case.destiny
                    }
                }

                $.ajax({
                    url: api_base_url + '/covid19-routes/api/v1.0/ciudad-real/survey/',
                    data: JSON.stringify(data),
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function(response) {
                        alert("The suervey is complete. You can select other case.");
                    },
                    error: function(error) {
                        console.log("Error sending data");
                    }
                });
            }
        }
    </script>
</body>

</html>