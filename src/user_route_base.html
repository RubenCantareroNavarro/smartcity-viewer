<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Survey: case base</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <style>
        .add_marker_class {
            position: relative;
            box-shadow: inset 0px 1px 0px 0px #f7c5c0;
            background-color: #fc8d83;
            border-radius: 6px;
            border: 1px solid #d83526;
            display: inline-block;
            cursor: pointer;
            color: #ffffff;
            font-family: Arial;
            font-size: 20px;
            font-weight: bold;
            padding: 20px 20px;
            text-decoration: none;
            text-shadow: 0px 1px 0px #b23e35;
        }
        
        .add_marker_class:hover {
            background-color: #e4685d;
        }
        
        .add_marker_class:active {
            /* bottom: 1px; */
            background-color: #c75c52;
            color: #ffffff;
        }
    </style>

    <div id="map"></div>
    <a href="#" class="add_marker_class" onclick="sendResult()">Send result</a>
    <a href="#" class="add_marker_class" onclick="addMarker()">Add marker</a>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoicnViZW5jbjkwIiwiYSI6ImNrYWdudzluOTA1Zm0zMW1vcGxiZDFpN3gifQ.Gi7bav34XZCKoS9SczeeDg';
        var origin = [-3.920102, 38.990590];
        var ciudad_real = [-3.927374, 38.985531];

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/rubencn90/ckfwo9gop092p19uektbw5mz3/draft',
            center: ciudad_real,
            zoom: 14
        });

        var pickers = Array();
        var routes_geometry = Array();

        map.on('load', function() {
            map.addSource('route', {
                'type': 'geojson',
                lineMetrics: true,
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer({
                'id': 'route_layer',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#ff004c',
                    'line-width': 6,
                    'line-gradient': [
                        'interpolate', ['linear'],
                        ['line-progress'],
                        0,
                        '#8800ff',
                        0.125,
                        '#5100ff',
                        0.250,
                        '#000dff',
                        0.375,
                        '#0066ff',
                        0.5,
                        '#00a2ff',
                        0.625,
                        '#00e5ff',
                        0.750,
                        '#00fff7',
                        0.875,
                        '#00ffc3',
                        1,
                        '#05ff93'
                    ]
                }
            });

            initial_picker = new mapboxgl.Marker({
                    draggable: false,
                    color: '#0cf700'
                })
                .setLngLat(origin)
                .addTo(map);

            pickers.push(initial_picker);
        });


        function addMarker() {
            picker = new mapboxgl.Marker({
                    draggable: true,
                    color: '#00f7da'
                })
                .setPopup(new mapboxgl.Popup().setHTML(pickers.length))
                .setLngLat(map.getCenter())
                .addTo(map);

            picker.on('dragend', updateRoute);
            pickers.push(picker);
            updateRoute();
        }

        function updateRoute() {
            for (var i = pickers.length - 1; i > 0; i--) {
                var destination = pickers[i].getLngLat();
                var origin = pickers[i - 1].getLngLat();

                showRoute('route', 'danger', origin.lat, origin.lng, destination.lat, destination.lng, i);
            }
        }

        function showRoute(source, route_type, origin_lat, origin_lon, destination_lat, destination_lon, index) {
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5001/covid19-routes/api/v1.0/ciudad-real/route/",
                data: {
                    route_type: route_type,
                    origin_lat: origin_lat,
                    origin_lon: origin_lon,
                    destination_lat: destination_lat,
                    destination_lon: destination_lon
                },
                success: function(response) {
                    data = prepareJSONLine(response.geometry.coordinates, index);
                    map.getSource(source).setData(data);
                }
            });
        }

        function prepareJSONLine(new_coordinates, index) {
            if (routes_geometry.length == index - 1) {
                routes_geometry.push(new_coordinates);
            } else {
                routes_geometry[index - 1] = new_coordinates;
            }

            data = {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': preparePoints()
                }
            };
            return data;
        }

        function preparePoints() {
            coordinates = Array();
            routes_geometry.forEach(element => {
                element.forEach(element2 => {
                    coordinates.push(element2);
                });
            });
            return coordinates;
        }

        function sendResult() {
            if (confirm("Are you sure?")) {
                var data = {
                    coordinates: preparePoints(),
                    user: "Ruben",
                    case: document.title
                };

                console.log(data);

                $.ajax({
                    url: 'http://127.0.0.1:5001/covid19-routes/api/v1.0/ciudad-real/survey/',
                    data: JSON.stringify(data),
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function(response) {
                        alert("The suervey is complete. You can close the window.");
                    },
                    error: function(error) {
                        console.log("Error sending data");
                    }
                });
            }
        }
    </script>
</body>

</html>